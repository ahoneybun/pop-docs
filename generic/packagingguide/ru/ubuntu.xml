<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.3//EN"
	"http://www.oasis-open.org/docbook/xml/4.3/docbookx.dtd" [
<!ENTITY % globalent SYSTEM "../../../libs/global.ent">
%globalent;
<!ENTITY % cdo-C SYSTEM "../../../libs/cdo-C.ent">
%cdo-C;
<!ENTITY % pg-common SYSTEM "../pg-common.ent">
%pg-common;
<!ENTITY % xinclude SYSTEM "../../../libs/xinclude.mod">
%xinclude;
<!ENTITY language "en">
]>
<chapter id="ubuntu-chap" status="complete">
	<title>Система пакетов Ubuntu</title>

	<sect1 id="ubuntu-upload" status="complete">
		<title>Опубликование и просмотр</title>

		<para>Once you have created a source package (either a completely new package or
			just an update/bugfix), you will want to distribute your
			package so that other people can enjoy your hard work. The most effective way
			to do that for <phrase>Ubuntu</phrase> is to contribute your package to the Universe repository.
			The community developers who are responsible for the Universe repository are
			known as Masters of the Universe (<ulink url="https://wiki.ubuntu.com/MOTU">MOTU</ulink>). <ulink url="http://revu.tauware.de">REVU</ulink> is a web-based tool that gives
			people a place to upload their source packages for other people to look at and
			for MOTUs to review in a structured manner.</para>

		<sect2 id="contribute-as-uploader">
			<title>Сотрудничество в качестве автора</title>
		
			<para>Первым делом, вам необходимо добавить собственный <ulink url="https://wiki.ubuntu.com/GPGKey">GPG Ключ</ulink> в каталог ключей REVU. Этот шаг подтверждает, что ваш пакет действительно происходит от вас и помогает отслеживать опубликование пакетов.</para>
	
			<para>REVU uses your <ulink url="https://launchpad.net">Launchpad</ulink> account to look up your <application>gpg</application> key so make sure you have a Launchpad account and you have put your <application>gpg</application> key in your user profile there. Once this is one you can join the <ulink url="https://launchpad.net/people/ubuntu-universe-contributors">Universe Contributors</ulink> team and then email <ulink url="mailto:admin@tiber.tauware.de">admin@tiber.tauware.de</ulink> asking for your <application>gpg</application> key to be updated on REVU. When this is done you will be able to upload your packages. You don't	need a password to upload packages, only to log in to the website and to reply to comments.</para>

			<note><para>Необязательно, чтобы ваш ключ был подписан другими при опубликовании на REVU, но неплохая идея все таки это когда-нибудь сделать.</para></note>
			
			
			<sect3 id="upload-your-packages">
				<title>Опубликование ваших пакетов</title>

				<para>Uploading to REVU uses <application>dput</application>. The <phrase>Ubuntu</phrase>
					version of <application>dput</application> already knows about REVU so
					you do not need to change any configuration files. Only upload signed
					packages, and unlike other repositories, you should always include the
					original tarball, otherwise reviewers will not be able to look at your
					extracted source package. In order to do so, use the options "-S -sa"
					with <application>debuild</application> or
					<application>dpkg-buildpackage</application> to build only the source
					package and to include the original source in the upload.</para>
				
				<para>После того как пакет с исходным кодом создан, вы можете использовать <application>dput</application> с изменениями в конфигурационном файле для опубликования путем простого указания <filename>_source.changes</filename> файла, который был создан:</para>

				<screen>dput revu *_source.changes</screen>

				<note><para>Если вы перезагружаете измененный пакет (после получения рецензии), вы может получить ошибку вида:</para>
					
				<screen>
Upload package to host revu
Already uploaded to tauware.de
Doing nothing for myapp_source.changes</screen>
			
				<para>Чтобы исправить это, добавьте ключ -f для dput, чтобы заставить процесс загрузки удалить файл <filename>.upload</filename>, созданный ранее <application>dput</application>.</para></note>
			
				<para>Processing of uploads is done every five minutes, so if your upload does not show up,
				please contact the REVU administrators by email, or join the Freenode IRC channel #ubuntu-motu.</para>
		
			</sect3>
		
			<sect3 id="howto-login">
				<title>Процедура идентификации REVU</title>
			
				<para>После вашей первой загрузки, вы будете автоматически зарегистрированы в базе данных, и вам присвоят сгенерированный случайным образом пароль. На веб-сайте <ulink url="http://revu.tauware.de">REVU</ulink> воспользуйтесь адресом электронной почты, который вы использовали в changelog  файле вашей загрузки, в качестве имени пользователя и щелкните по ссылке 'recover password' (восстановить пароль). Далее, вы попадете на страницу, содержащую ваш пароль в зашифрованном виде и инструкцию для его расшифровки.</para>
				
			</sect3>

			<sect3 id="view-and-comment-uploads">
				<title>Просмотр и комментирование загрузок</title>
			
				<para>Пакеты, загруженные на REVU, находятся в открытом доступе. Вы можете просматривать их без проходения авторизации на сервере. Однако, возможность комментирования загрузок доступна лишь зарегистрированным пользователям. Как uploader, вы можете комментировать только свои собственные загрузки. Это может быть использовано для предоставления рецензентам дополнительной информации об изменениях, внесенных вами, между двумя загрузками ваших пакетов.</para>

			</sect3>

			<sect3 id="additional-rules">
				<title>Дополнительне правила</title>
		
				<itemizedlist>

					<listitem><para>Вы дожны изучить состояние пакета на предмет известных уязвимостей, влияющих на безопасность, и предоставить исправления для них.</para></listitem>
					
					<listitem><para>Пакет может отклонен на основе информации об известных проблемах безопасности.</para></listitem>
					
					<listitem><para>Вы должны включить файлы copyright и license, и они должны позволять включение пакета в раздел Universe и разрешение на распространение через зеркала Ubuntu.</para></listitem>
					
					<listitem><para>The package must be known to build on top of the main component
							of the current <phrase>Ubuntu</phrase> stable release. It is permissible to require other
							packages already in Universe.</para></listitem>
				</itemizedlist>
			</sect3>

			<sect3 id="getting-help">
				<title>Получение помощи</title>
				<para>If you need assistance on these steps, or if you have questions about REVU, you can
					ask in #ubuntu-motu on the Freenode IRC network.</para>
			</sect3>

		</sect2>

	</sect1>

	<sect1 id="ubuntu-sync" status="complete">
		<title>Слияние и синхронизация</title>



		<important><para><emphasis role="bold">Требования:</emphasis> build-essential, automake, gnupg, lintian, fakeroot, patchutils, debhelper и <xref linkend="gs-pbuilder"/>.</para></important>
		
		<para><phrase>Ubuntu</phrase> is based on the Debian Linux distribution and uses the same package
			management system (APT). At the beginning of each <phrase>Ubuntu</phrase> development cycle, the
			packages in <phrase>Ubuntu</phrase> are updated to those in the Debian unstable branch. However,
			because <phrase>Ubuntu</phrase> is not the same as Debian, some of the packages need to
			be modified to work in <phrase>Ubuntu</phrase>. There might also be bug fixes that <phrase>Ubuntu</phrase>
			developers have introduced into the packages. You can determine whether this has
			taken place by noting the package version. If the package version includes
			ubuntu in it (an example would be gimp-2.2.9-3ubuntu2), then the <phrase>Ubuntu</phrase>
			developers have made changes, and it is no longer the same as the Debian package.
			There are more than 1000 such modified packages in the Universe repository.</para>
		
		<para>At the start of each Ubuntu development cycle, a decision is made regarding
			these Ubuntu versioned packages. Of course if the Debian version hasn't
			changed since the last <phrase>Ubuntu</phrase> release, then nothing needs to be changed.
			However, if there is a newer version of the package in Debian, then one
			of two things should happen. If all of the reasons for Ubuntu modifications
			(bug fixes, dependencies, etc.) are fixed in the new Debian package,
			then we can just take the Debian package directly. This decision is called a
			<emphasis>sync</emphasis>. However, if the new Debian version has the same
			issues that caused the Ubuntu version to be made, then those changes need
			to be applied to the new Debian version, too. This decision is called <emphasis>merging</emphasis>.
		</para>
		<sect2 id="merge-tutorial">
			<title>Учебное пособие по слиянию</title>
			<para>Процесс объединения заключается в просмотре изменений в пакетах с исходными кодами в Debian и Ubuntu и определении того что изменено и какие изменения специфичны для Ubuntu.</para>
			<para>Для начала создайте каталог, который будет содержать наш проект, после перейдите в него:</para>
			<screen>
mkdir ~/xcdroast
cd ~/xcdroast</screen>
			<para>Теперь загрузите все задействованные пакеты с исходными кодами в этот каталог:</para>
			<itemizedlist>
				<listitem><para>Архив исходных кодов <application>xcdroast</application>, используемый всеми версиями:</para>
					<itemizedlist>
						<listitem>
<para><ulink url="http://snapshot.debian.net/archive/2006/01/16/debian/pool/main/x/xcdroast/xcdroast_0.98+0alpha15.orig.tar.gz">xcdroast_0.98+0alpha15.orig.tar.gz</ulink></para>
						</listitem>
					</itemizedlist>
				</listitem>
				<listitem>
					<para>The <phrase>Ubuntu</phrase> Breezy source package files:</para>
					<itemizedlist>
						<listitem><para>
<ulink url="http://doc.ubuntu.com/files/packagingguide/xcdroast_0.98+0alpha15-1.1ubuntu1.dsc">xcdroast_0.98+0alpha15-1.1ubuntu1.dsc</ulink></para>
						</listitem>
						<listitem><para>
<ulink url="http://doc.ubuntu.com/files/packagingguide/xcdroast_0.98+0alpha15-1.1ubuntu1.diff.gz">xcdroast_0.98+0alpha15-1.1ubuntu1.diff.gz</ulink></para>
						</listitem>
					</itemizedlist>
				</listitem>
				<listitem>
					<para>Файлы пакета с исходными кодами Debian, на базе которых сделаны пакеты Breezy:</para>
						<itemizedlist>
							<listitem>
<para><ulink url="http://doc.ubuntu.com/files/packagingguide/xcdroast_0.98+0alpha15-1.1.diff.gz">xcdroast_0.98+0alpha15-1.1.diff.gz</ulink></para>
							</listitem>
							<listitem>
<para><ulink url="http://doc.ubuntu.com/files/packagingguide/xcdroast_0.98+0alpha15-1.1.dsc">xcdroast_0.98+0alpha15-1.1.dsc</ulink></para>
							</listitem>
						</itemizedlist>
				</listitem>
				<listitem>
					<para>Файлы нового пакета с исходными кодами Debian, на базе которых будут сделаны пакеты для Dapper:</para>
					<itemizedlist>
						<listitem>
<para><ulink url="http://doc.ubuntu.com/files/packagingguide/xcdroast_0.98+0alpha15-3.dsc">xcdroast_0.98+0alpha15-3.dsc</ulink></para>
						</listitem>
						<listitem>
<para><ulink url="http://doc.ubuntu.com/files/packagingguide/xcdroast_0.98+0alpha15-3.diff.gz">xcdroast_0.98+0alpha15-3.diff.gz</ulink></para>
						</listitem>
					</itemizedlist>
				</listitem>
			</itemizedlist>
			<note><para>Для выполнения данных шагов используйте поиск пакетов Debian на <ulink url="packages.debian.org">packages.debian.org</ulink> и пакетов Ubuntu на <ulink url="packages.ubuntu.com">packages.ubuntu.com</ulink>.</para></note>
		<tip><para>Очень полезным при выполнении слияний (или подготовки пакетов Ubuntu) оказывается пакет <application>devscripts</application>. Если вы еще не установили его, сделайте это перед тем, как продолжить.</para></tip>
			
			<para>By looking at the <phrase>Ubuntu</phrase> changelog you should be able to see which differences
				to expect between the Ubuntu package and the Debian package from which it was derived.
				For xcdroast, the <phrase>Ubuntu</phrase> changelog can be found at
	<ulink url="http://changelogs.ubuntu.com/changelogs/pool/universe/x/xcdroast/xcdroast_0.98+0alpha15-1.1ubuntu1/changelog">
					changelogs.ubuntu.com</ulink>. It says that a .desktop file was fixed and properly
				installed to close a bug reported in
				<ulink url="https://launchpad.net/malone/bugs/2698">Malone</ulink>.
			</para>
			
			<para>Теперь, внимательно изучите изменения внесенные в пакеты исходных кодов:</para>
			<screen>
debdiff xcdroast_0.98+0alpha15-1.1.dsc xcdroast_0.98+0alpha15-1.1ubuntu1.dsc | \
	ubuntu.debdiff | less ubuntu.debdiff</screen>
			
			<para>The lines that start with - have been removed from the Debian package, and those that start
				with + have been added to the <phrase>Ubuntu</phrase> package.</para>
			<para>И вот, что мы видим:</para>
			<itemizedlist>
				<listitem>
					<para>В debian/rules использовался install вместо cp для установки иконки xcdroast. В дополнение, есть новая строка, устанавливающая файл .desktop.</para>
				</listitem>
				<listitem>
					<para>В debian/changelog произведенные модификации добавлены в файл changelog.</para>
				</listitem>
				<listitem>
					<para>В debian/dirs было добавлено usr/share/applications для правильной работы строк инсталляции, находящиеся выше.</para>
				</listitem>
				<listitem>
					<para>добавлен xcdroast.desktop</para>
				</listitem>
			</itemizedlist>
			
			<para>Теперь мы знаем, какие изменения были внесены в исходный код Ubuntu. Далее нам необходимо просмотреть, какие изменения сделаны в исходном коде Debian.</para>
			<screen>
debdiff xcdroast_0.98+0alpha15-1.1.dsc xcdroast_0.98+0alpha15-3.dsc &gt; debian.debdiff
less debian.debdiff</screen>
			<para>В этом debdiff файле намного больше изменений, чем в рассмотренном выше. Один из способов получить представление о том, что же было изменено, - это проверить в debdiff, какие именно файлы были измененны:</para>
			
			<screen>grep diff debian.debdiff</screen>
			
			<para>Данная команда показывает, что в новой версии Debian были изменены файлы debian/postinst, debian/rules, debian/changelog, debian/doc-base.manual, debian/control, и debian/menu.</para>
			<para>Thus we can see that we need to check debian/rules to see if the <phrase>Ubuntu</phrase> changes were made.
				We can also see that debian/dirs was not changed from the old Debian version. Let us
				now look at the files. We can unpack the source package by using
				<application>dpkg-source</application>:</para>
			
			<screen>dpkg-source -x xcdroast_0.98+0alpha15-3.dsc</screen>
			
			<para>Данная команда разархиврует файл xcdroast_0.98+0alpha15.orig.tar.gz, создаст каталог xcdroast-0.98+0alpha15 и применит модификации, найденные в xcdroast_0.98+0alpha15-3.diff.gz.</para>
			<para>Перейдите в каталог debian:</para>
			
			<screen>cd xcdroast-0.98+0alpha15/debian</screen>
			
			<para>One can see in <filename>rules</filename> that changes made by <phrase>Ubuntu</phrase> were not applied to the new Debian version.
				This means that:</para>
			
			<screen>cp debian/xcdroast.xpm `pwd`/debian/$(PACKAGE)/usr/share/pixmaps</screen>
			
			<para>...должно быть изменено на:</para>
			
			<screen>
#cp debian/xcdroast.xpm `pwd`/debian/$(PACKAGE)/usr/share/pixmaps

#install desktop and icon
install -D -m 644 $(CURDIR)/debian/xcdroast.desktop \
	$(CURDIR)/debian/xcdroast/usr/share/applications/xcdroast.desktop
install -D -m 644 $(CURDIR)/debian/xcdroast.xpm \
	 $(CURDIR)/debian/xcdroast/usr/share/pixmaps/xcdroast.xpm</screen>

			<para>Теперь необходимо добавить следующие строки в <filename>dirs</filename> для того чтобы был установлен файл .desktop:</para>
			<screen>usr/share/applications</screen>
			
			<para>Теперь нам потребуется текущий файл .desktop (сохраненный как  <emphasis>debian/xcdroast.desktop</emphasis>). Из ubuntu.debdiff (или пакета с исходными кодами Ubuntu) мы видим то это:</para>
			<screen>
[Desktop Entry]
Encoding=UTF-8
Name=X-CD-Roast
Comment=Create a CD
Exec=xcdroast
Icon=xcdroast.xpm
Type=Application
Categories=Application;AudioVideo;</screen>
			
			<para>The last change that needs to be made is in <filename>changelog</filename>. 
				Not only do we need to add what we have just done (merge with Debian), but we 
				should also add in the previous <phrase>Ubuntu</phrase> changelog entries. To do this, run 
				<application>dch -i -D dapper</application> and put something to the effect of:</para>
			<screen>
xcdroast (0.98+0alpha15-3<emphasis>ubuntu1</emphasis>) dapper; urgency=low

  * Resynchronise with Debian.</screen>

			<para>Make sure to change the version number to the correct <phrase>Ubuntu</phrase> version.
				Also add:</para>
			<screen>
xcdroast (0.98+0alpha15-1.1ubuntu1) breezy; urgency=low

  * Fix and install existing .desktop file. (Closes Malone #2698)
				
  -- Captain Packager &lt;packager@coolness.com&gt; Sat, 1 Oct 2005 19:39:04 -0400</screen>
			<para>между записями лога 0.98+0alpha15-1.1 и 0.98+0alpha15-2</para>
			
			<para>Теперь вы можете откомпилировать и протестировать новый пакет исходных кодов. Есть разные способы сделать это. Один из примеров:</para>
			<screen>
cd ..
debuild -S
cd ..
sudo pbuilder build xcdroast_0.98+0alpha15-3ubuntu1.dsc</screen>
			
			<para>This will recreate the source package, sign it with your default GPG key, and build the package in a pbuilder
				environment to make sure it builds correctly. Make sure to always test your packages
				before submitting patches. The last step is to make a debdiff that can be
				attached to an existing bug report or given to the MOTUs in the #ubuntu-motu IRC channel. To do this,
				we get the difference between the Debian unstable source package and the new <phrase>Ubuntu</phrase> version:
			</para>
			<screen>debdiff xcdroast_0.98+0alpha15-3.dsc xcdroast_0.98+0alpha15-3ubuntu1.dsc &gt; \
	xcdroast_0.98+0alpha15-3ubuntu1.debdiff</screen>
		</sect2>
	</sect1>

	<sect1 id="ubuntu-kubuntu" status="complete">
		<title>Сборка пакетов для Kubuntu</title>
		
		<para>Как вы уже, наверное, догадались, специфические проблемы со сборкой пакетов под Kubuntu связаны с KDE и Qt.</para>
		
		<sect2 id="build-dependencies">
			<title>Зависимости при сборке</title>
	
			<para>Программы в Kubuntu - это в основном программы KDE. Следовательно, при сборке они зависят (Build-Depend) от <filename>kdelibs4-dev</filename>. Так как KDE ориентировано на взаимодействие программ, некоторые из них могут зависеть (Build-Depend) от других частей KDE, таких как <filename>kdepim-dev</filename>. Убедитесь, что вы имеете список необходимых зависимостей для вашей программы.</para>
	
		</sect2>

		<sect2 id="desktop-files">
			<title>Файлы рабочего стола</title>
		
			<para>KDE использует некоторые специфические пути. Большинство настроек KDE хранятся либо в <filename>/etc/kde3/</filename>, либо в <filename>/usr/share/apps/</filename>. Важное замечание: основные файлы рабочего стола KDE должны устанавливаться в <filename>/usr/share/applications/kde/</filename>. Путь установки для файлов рабочего стола должен быть зафиксирован, если они это не используют (исключение составляют файлы рабочего стола подобные служебным меню).</para>
			
			<para>Файлы рабочего стола KDE также должны иметь специфические секции, чтобы соответствовать KMenu. Минимальный файл рабочего стола для программы KDE может выглядеть примерно так:</para>
				
			<screen>[Desktop Entry]
Encoding=UTF-8
Name=Kfoo
Name[xx]=Kfoo
GenericName=Bar description
Exec=kfoo
Icon=kfoo
Terminal=false
Categories=Qt;KDE;Utility;</screen>

			<para>Заметьте, что поле Categories должно начинаться с Qt;KDE;. Есть специальные записи файлов рабочего стола для программ KDE и модулей, которые позволяют su объявить эти программы как KCModules или автоматически запускать их при входе в систему.</para>
	
		</sect2>
		
		<sect2 id="generating-pot-files">
			<title>Генерирование файлов .pot</title>

			<para>The Ubuntu translation website, <ulink url="https://launchpad.net/rosetta/">Rosetta</ulink>, now supports KDE,
				which means KDE packages need to support Rosetta by generating .pot
				template files for translators. If you use <application>cdbs</application>
				in edgy, your package should now automatically build and check
				for a .pot file in po/ directory.</para>

			<para>Вам также нужен <ulink url="../files/kubuntu_01_kdepot.diff">kdepot patch</ulink> (или подобный; его применение может пройти не совсем гладко, что зависит от возраста каталога admin).</para>

			<para>Если ваш пакет использует <application>debhelper</application> или <application>cdbs</application> и содержит его собственный файл kde.mk, вам нужно вручную самостоятельно добавить соответствующие правила.</para>

			<para>Для <application>cdbs</application>, добавьте следующие строки в файл debian/rules:</para>

			<screen>
common-post-build-arch::
	mkdir -p po
        XGETTEXT=/usr/bin/kde-xgettext sh admin/cvs.sh extract-messages

clean::
       rm -rf po</screen>
			<para>Для <application>debhelper</application> добавьте следующее в конце правила <emphasis>install</emphasis>:</para>
			<screen>
mkdir -p po
XGETTEXT=/usr/bin/kde-xgettext sh admin/cvs.sh extract-messages</screen>
			<para>Также для <application>debhelper</application> добавьте следующее в конце правила <emphasis>clean</emphasis>:</para>
			<screen>
rm -f po/*.pot</screen>
		</sect2>
		
	</sect1>

</chapter>

